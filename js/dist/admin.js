(function(a,_,l,c,g,r,f,b){"use strict";class y extends f{constructor(){super(...arguments),this.loading=!0,this.platforms=[],this.newPlatformName=g(""),this.newPlatformIconUrl=g(""),this.newPlatformIconClass=g(""),this.submitting=!1}oninit(t){super.oninit(t),this.loadPlatforms()}view(){return this.loading?m(c,null):m("div",{className:"PlatformManagement"},m("div",{className:"PlatformManagement-header"},m("h3",null,a.translator.trans("wusong8899-tournament-widget.admin.platforms.title"))),m("div",{className:"PlatformManagement-addForm"},m("h4",null,a.translator.trans("wusong8899-tournament-widget.admin.platforms.add_button")),m("div",{className:"Form-group"},m("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.platforms.name_label")),m("input",{className:"FormControl",type:"text",value:this.newPlatformName(),onchange:t=>this.newPlatformName(t.target.value),placeholder:a.translator.trans("wusong8899-tournament-widget.admin.platforms.name_help")})),m("div",{className:"Form-group"},m("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.platforms.icon_url_label")),m("input",{className:"FormControl",type:"url",value:this.newPlatformIconUrl(),onchange:t=>this.newPlatformIconUrl(t.target.value),placeholder:a.translator.trans("wusong8899-tournament-widget.admin.platforms.icon_url_help")})),m("div",{className:"Form-group"},m("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.platforms.icon_class_label")),m("input",{className:"FormControl",type:"text",value:this.newPlatformIconClass(),onchange:t=>this.newPlatformIconClass(t.target.value),placeholder:a.translator.trans("wusong8899-tournament-widget.admin.platforms.icon_class_help")})),m(l,{className:"Button Button--primary",loading:this.submitting,onclick:()=>this.createPlatform()},a.translator.trans("wusong8899-tournament-widget.admin.platforms.add_button"))),m("div",{className:"PlatformManagement-list"},m("h4",null,"Existing Platforms"),this.platforms.length>0?m("div",{className:"PlatformList"},this.platforms.map(t=>m("div",{key:t.id,className:"PlatformList-item"},m("div",{className:"platform-info"},m("div",{className:"platform-icon"},this.renderPlatformIcon(t)),m("div",{className:"platform-details"},m("div",{className:"platform-name"},t.attributes.name),m("div",{className:"platform-meta"},t.attributes.iconUrl&&m("span",{className:"meta-item"},"URL Icon: ",t.attributes.iconUrl),t.attributes.iconClass&&m("span",{className:"meta-item"},"CSS Icon: ",t.attributes.iconClass)))),m("div",{className:"platform-controls"},m(b,{state:t.attributes.isActive,onchange:e=>this.updatePlatform(t.id,{isActive:e})},t.attributes.isActive?a.translator.trans("wusong8899-tournament-widget.admin.platforms.enable"):a.translator.trans("wusong8899-tournament-widget.admin.platforms.disable")),m(l,{className:"Button Button--danger Button--icon",icon:"fas fa-trash",onclick:()=>this.deletePlatform(t.id),title:"Delete Platform"}))))):m("div",{className:"PlatformList-empty"},a.translator.trans("wusong8899-tournament-widget.admin.platforms.empty"))))}async loadPlatforms(){try{const t=await a.request({method:"GET",url:a.forum.attribute("apiUrl")+"/tournament/platforms"});this.platforms=t.data||[],this.loading=!1,m.redraw()}catch(t){console.error("Failed to load platforms:",t),this.loading=!1,m.redraw()}}async createPlatform(){if(!this.newPlatformName().trim()){a.alerts.show({type:"error"},"Platform name is required");return}this.submitting=!0,m.redraw();try{const t=await a.request({method:"POST",url:a.forum.attribute("apiUrl")+"/tournament/platforms",body:{data:{type:"platforms",attributes:{name:this.newPlatformName(),iconUrl:this.newPlatformIconUrl()||null,iconClass:this.newPlatformIconClass()||null,isActive:!0,displayOrder:this.platforms.length}}}});this.platforms.push(t.data),this.newPlatformName(""),this.newPlatformIconUrl(""),this.newPlatformIconClass(""),a.alerts.show({type:"success"},"Platform created successfully")}catch(t){console.error("Failed to create platform:",t),a.alerts.show({type:"error"},"Failed to create platform")}finally{this.submitting=!1,m.redraw()}}async updatePlatform(t,e){try{const s=await a.request({method:"PATCH",url:a.forum.attribute("apiUrl")+"/tournament/platforms/"+t,body:{data:{type:"platforms",attributes:e}}}),n=this.platforms.findIndex(o=>o.id===t);n!==-1&&(this.platforms[n]=s.data,m.redraw())}catch(s){console.error("Failed to update platform:",s),a.alerts.show({type:"error"},"Failed to update platform")}}async deletePlatform(t){if(confirm("Are you sure you want to delete this platform?"))try{await a.request({method:"DELETE",url:a.forum.attribute("apiUrl")+`/tournament/platforms/${t}`}),this.platforms=this.platforms.filter(e=>e.id!==t),a.alerts.show({type:"success"},"Platform deleted successfully"),m.redraw()}catch(e){console.error("Failed to delete platform:",e),a.alerts.show({type:"error"},"Failed to delete platform")}}renderPlatformIcon(t){const{iconUrl:e,iconClass:s}=t.attributes;return e?m("img",{src:e,alt:t.attributes.name,className:"platform-icon-img"}):s?m("i",{className:`platform-icon-css ${s}`}):m("i",{className:"platform-icon-css fas fa-gamepad"})}}class k extends f{constructor(){super(...arguments),this.loading=!0,this.saving=!1,this.rankTitles={},this.entries=[],this.nextId=1}oninit(t){super.oninit(t),this.loadRankTitles()}view(){return this.loading?m(c,null):m("div",{className:"RankTitleManagement"},m("div",{className:"RankTitleManagement-header"},m("h3",null,a.translator.trans("wusong8899-tournament-widget.admin.rank_titles.title")),m("div",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.rank_titles.help"))),m("div",{className:"RankTitleManagement-list"},m("div",{className:"RankTitleManagement-listHeader"},m("div",{className:"rank-column"},a.translator.trans("wusong8899-tournament-widget.admin.rank_titles.rank_label")),m("div",{className:"title-column"},a.translator.trans("wusong8899-tournament-widget.admin.rank_titles.title_label")),m("div",{className:"actions-column"},"Actions")),this.entries.map(t=>m("div",{key:t.id,className:"RankTitleManagement-entry"},m("div",{className:"rank-column"},m("input",{className:"FormControl",type:"text",value:t.rank,placeholder:"1, 2-5, default",onchange:e=>this.updateEntryRank(t.id,e.target.value)})),m("div",{className:"title-column"},m("input",{className:"FormControl",type:"text",value:t.title,placeholder:a.translator.trans("wusong8899-tournament-widget.admin.rank_titles.title_placeholder"),onchange:e=>this.updateEntryTitle(t.id,e.target.value)})),m("div",{className:"actions-column"},m(l,{className:"Button Button--icon",icon:"fas fa-times",onclick:()=>this.removeEntry(t.id),title:"Remove"}))))),m("div",{className:"RankTitleManagement-actions"},m(l,{className:"Button",icon:"fas fa-plus",onclick:()=>this.addEntry()},a.translator.trans("wusong8899-tournament-widget.admin.rank_titles.add_rank")),m(l,{className:"Button Button--primary",loading:this.saving,onclick:()=>this.saveRankTitles()},a.translator.trans("wusong8899-tournament-widget.admin.rank_titles.save_button"))),m("div",{className:"RankTitleManagement-preview"},m("h4",null,a.translator.trans("wusong8899-tournament-widget.admin.rank_titles.preview_title")),m("div",{className:"preview-content"},this.renderPreview())))}async loadRankTitles(){try{const t=await a.request({method:"GET",url:a.forum.attribute("apiUrl")+"/tournament/rank-titles"});this.rankTitles=t.data.attributes.rankTitles||{},this.entriesFromRankTitles(),this.loading=!1,m.redraw()}catch(t){console.error("Failed to load rank titles:",t),this.loading=!1,m.redraw()}}entriesFromRankTitles(){this.entries=[],this.nextId=1,Object.entries(this.rankTitles).forEach(([t,e])=>{this.entries.push({id:String(this.nextId++),rank:t,title:e})}),this.entries.length===0&&this.addEntry()}addEntry(){this.entries.push({id:String(this.nextId++),rank:"",title:""}),m.redraw()}removeEntry(t){this.entries=this.entries.filter(e=>e.id!==t),m.redraw()}updateEntryRank(t,e){const s=this.entries.find(n=>n.id===t);s&&(s.rank=e,m.redraw())}updateEntryTitle(t,e){const s=this.entries.find(n=>n.id===t);s&&(s.title=e,m.redraw())}async saveRankTitles(){this.saving=!0,m.redraw();const t={};this.entries.forEach(e=>{e.rank.trim()&&e.title.trim()&&(t[e.rank.trim()]=e.title.trim())});try{await a.request({method:"POST",url:a.forum.attribute("apiUrl")+"/tournament/rank-titles",body:{data:{type:"rank-titles",attributes:{rankTitles:t}}}}),this.rankTitles=t,a.alerts.show({type:"success"},a.translator.trans("core.admin.saved_message"))}catch(e){console.error("Failed to save rank titles:",e),a.alerts.show({type:"error"},"Failed to save rank titles")}finally{this.saving=!1,m.redraw()}}renderPreview(){const t=[1,2,3,5,15,25];return m("div",{className:"preview-list"},t.map(e=>{const s=this.getTitleForRank(e);return m("div",{key:e,className:"preview-item"},m("span",{className:"preview-rank"},"#",e),m("span",{className:"preview-title"},s))}))}getTitleForRank(t){const e={};if(this.entries.forEach(s=>{s.rank.trim()&&s.title.trim()&&(e[s.rank.trim()]=s.title.trim())}),e[String(t)])return e[String(t)];for(const[s,n]of Object.entries(e))if(s.includes("-")){const[o,i]=s.split("-").map(Number);if(t>=o&&t<=i)return n}return e.default||"参赛选手"}}class P extends f{constructor(){super(...arguments),this.participants=[],this.loading=!1,this.saving=!1,this.deleting=!1,this.editingScores={}}oninit(t){super.oninit(t),this.loadParticipants()}view(){return this.loading?m(c,null):m("div",{className:"ParticipantManagement"},m("div",{className:"ParticipantManagement-header"},m("h3",null,a.translator.trans("wusong8899-tournament-widget.admin.participants.title")),m("p",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.participants.description"))),this.participants.length===0?m("div",{className:"ParticipantManagement-empty"},m("p",null,a.translator.trans("wusong8899-tournament-widget.admin.participants.no_participants"))):m("div",{className:"ParticipantManagement-table"},m("table",{className:"Table"},m("thead",null,m("tr",null,m("th",null,a.translator.trans("wusong8899-tournament-widget.admin.participants.user")),m("th",null,a.translator.trans("wusong8899-tournament-widget.admin.participants.platform")),m("th",null,a.translator.trans("wusong8899-tournament-widget.admin.participants.score")),m("th",null,a.translator.trans("wusong8899-tournament-widget.admin.participants.actions")))),m("tbody",null,this.participants.map(t=>m("tr",{key:t.id},m("td",null,m("div",{className:"ParticipantManagement-user"},t.user.avatarUrl&&m("img",{src:t.user.avatarUrl,alt:t.user.displayName,className:"Avatar Avatar--size-small"}),m("span",{className:"username"},t.user.displayName||t.user.username))),m("td",null,m("div",{className:"ParticipantManagement-platform"},m("span",{className:"platform-name"},t.platform?.name||"Unknown"),t.platformUsername&&m("span",{className:"platform-username"},"(",t.platformUsername,")"))),m("td",null,m("div",{style:"display: flex; align-items: center; gap: 8px;"},m("input",{type:"number",className:"FormControl",style:"width: 100px;",value:this.editingScores[t.id]??t.score,oninput:e=>{this.editingScores[t.id]=parseInt(e.target.value)||0}}),m(l,{className:"Button Button--primary Button--size-small",loading:this.saving,disabled:this.saving||this.deleting,onclick:()=>this.updateScore(t)},a.translator.trans("wusong8899-tournament-widget.admin.participants.update")))),m("td",null,m("div",{style:"display: flex; gap: 8px; justify-content: center;"},m(l,{className:"Button Button--danger Button--size-small",loading:this.deleting,disabled:this.saving||this.deleting,onclick:()=>this.confirmDeleteParticipant(t)},a.translator.trans("wusong8899-tournament-widget.admin.participants.remove"))))))))),m("div",{className:"ParticipantManagement-actions"},m(l,{className:"Button",onclick:()=>this.loadParticipants(),loading:this.loading},a.translator.trans("wusong8899-tournament-widget.admin.participants.refresh"))))}async loadParticipants(){this.loading=!0,m.redraw();try{const e=await a.request({method:"GET",url:`${a.forum.attribute("apiUrl")}/tournament/participants?include=user,platform`}),s=e.included||[],n=s.filter(i=>i.type==="users"),o=s.filter(i=>i.type==="platforms");this.participants=e.data.map(i=>{const d=i.relationships?.user?.data?.id,u=n.find(p=>p.id===d),F=i.relationships?.platform?.data?.id,N=o.find(p=>p.id===F),h=i.attributes,w=u?.attributes,E=N?.attributes;return{id:parseInt(i.id,10),amount:h?.amount||0,score:h?.score||0,platformUsername:h?.platformUsername||"",createdAt:h?.createdAt||"",user:u?{id:parseInt(u.id,10),username:w?.username||"Unknown",displayName:w?.displayName||"Unknown",avatarUrl:w?.avatarUrl,money:w?.money||0}:{id:0,username:"Deleted User",displayName:"Deleted User",money:0},platform:N?{id:parseInt(N.id,10),name:E?.name||"Unknown"}:void 0}})}catch(t){console.error("Failed to load participants:",t),a.alerts.show({type:"error"},a.translator.trans("wusong8899-tournament-widget.admin.participants.load_error"))}finally{this.loading=!1,m.redraw()}}confirmDeleteParticipant(t){const e=a.translator.trans("wusong8899-tournament-widget.admin.participants.confirm_remove",{username:t.user.displayName||t.user.username});confirm(e)&&this.deleteParticipant(t)}async deleteParticipant(t){this.deleting=!0,m.redraw();try{await a.request({method:"DELETE",url:`${a.forum.attribute("apiUrl")}/tournament/participants/${t.id}`}),this.participants=this.participants.filter(e=>e.id!==t.id),a.alerts.show({type:"success"},a.translator.trans("wusong8899-tournament-widget.admin.participants.remove_success"))}catch(e){console.error("Failed to delete participant:",e),a.alerts.show({type:"error"},a.translator.trans("wusong8899-tournament-widget.admin.participants.remove_error"))}finally{this.deleting=!1,m.redraw()}}async updateScore(t){const e=this.editingScores[t.id];if(e!==t.score){this.saving=!0,m.redraw();try{await a.request({method:"PATCH",url:`${a.forum.attribute("apiUrl")}/tournament/participants/${t.id}`,body:{data:{type:"participants",attributes:{score:e}}}}),t.score=e,t.amount=e,a.alerts.show({type:"success"},a.translator.trans("wusong8899-tournament-widget.admin.participants.update_success"))}catch(s){console.error("Failed to update score:",s),a.alerts.show({type:"error"},a.translator.trans("wusong8899-tournament-widget.admin.participants.update_error")),this.editingScores[t.id]=t.score}finally{this.saving=!1,m.redraw()}}}}class T extends _{constructor(){super(...arguments),this.activeTab=g("general"),this.loading=!1,this.validationErrors={}}oninit(t){super.oninit(t),a.setTitle(a.translator.trans("wusong8899-tournament-widget.admin.title"))}content(){return this.loading?r(c,null):r("div",{className:"TournamentManagementPage"},r("div",{className:"container"},r("div",{className:"TournamentManagementPage-header"},r("h2",null,a.translator.trans("wusong8899-tournament-widget.admin.title")),r("p",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.description"))),r("nav",{className:"TournamentManagementPage-tabs"},this.renderTab("general","wusong8899-tournament-widget.admin.tabs.general"),this.renderTab("platforms","wusong8899-tournament-widget.admin.tabs.platforms"),this.renderTab("rank_titles","wusong8899-tournament-widget.admin.tabs.rank_titles"),this.renderTab("participants","wusong8899-tournament-widget.admin.tabs.participants")),r("div",{className:"TournamentManagementPage-content"},this.renderTabContent())))}renderTab(t,e){const s=this.activeTab()===t;return r(l,{className:`Button Button--text TournamentManagementPage-tab ${s?"active":""}`,onclick:()=>this.activeTab(t)},a.translator.trans(e))}renderTabContent(){switch(this.activeTab()){case"general":return this.renderGeneralSettings();case"platforms":return r(y,null);case"rank_titles":return r(k,null);case"participants":return r(P,null);default:return this.renderGeneralSettings()}}renderGeneralSettings(){return r("div",{className:"TournamentManagementPage-generalSettings"},r("div",{className:"Form"},r("div",{className:"Form-group"},r("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.settings.title_label")),r("input",{className:"FormControl",type:"text",bidi:this.setting("wusong8899_tournament.title")}),r("div",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.settings.title_help"))),r("div",{className:"Form-group"},r("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.settings.prize_pool_label")),r("input",{className:"FormControl",type:"text",bidi:this.setting("wusong8899_tournament.prize_pool")}),r("div",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.settings.prize_pool_help"))),r("div",{className:"Form-group"},r("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.settings.start_date_label")),r("input",{className:`FormControl ${this.validationErrors.start_date?"FormControl--error":""}`,type:"datetime-local",value:this.formatDateForInput(this.setting("wusong8899_tournament.start_date")()),step:"1",onchange:t=>this.validateAndSetDate(t.target.value)}),this.validationErrors.start_date&&r("div",{className:"FormGroup-error"},this.validationErrors.start_date),r("div",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.settings.start_date_help"))),r("div",{className:"Form-group"},r("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.settings.details_url_label")),r("input",{className:`FormControl ${this.validationErrors.details_url?"FormControl--error":""}`,type:"url",bidi:this.setting("wusong8899_tournament.details_url"),onchange:t=>this.validateUrl("details_url",t.target.value)}),this.validationErrors.details_url&&r("div",{className:"FormGroup-error"},this.validationErrors.details_url),r("div",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.settings.details_url_help"))),r("div",{className:"Form-group"},r("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.settings.background_image_label")),r("input",{className:`FormControl ${this.validationErrors.background_image?"FormControl--error":""}`,type:"url",bidi:this.setting("wusong8899_tournament.background_image"),onchange:t=>this.validateUrl("background_image",t.target.value)}),this.validationErrors.background_image&&r("div",{className:"FormGroup-error"},this.validationErrors.background_image),r("div",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.settings.background_image_help"))),r("div",{className:"Form-group"},r("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.settings.header_title_label")),r("input",{className:"FormControl",type:"text",bidi:this.setting("wusong8899_tournament.header_title")}),r("div",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.settings.header_title_help"))),r("div",{className:"Form-group"},r("label",{className:"FormLabel"},a.translator.trans("wusong8899-tournament-widget.admin.settings.header_image_label")),r("input",{className:`FormControl ${this.validationErrors.header_image?"FormControl--error":""}`,type:"url",bidi:this.setting("wusong8899_tournament.header_image"),onchange:t=>this.validateUrl("header_image",t.target.value)}),this.validationErrors.header_image&&r("div",{className:"FormGroup-error"},this.validationErrors.header_image),r("div",{className:"helpText"},a.translator.trans("wusong8899-tournament-widget.admin.settings.header_image_help"))),this.submitButton()))}validateUrl(t,e){if(!e.trim()){delete this.validationErrors[t],this.setting(`wusong8899_tournament.${t}`)(e);return}try{new URL(e),delete this.validationErrors[t],this.setting(`wusong8899_tournament.${t}`)(e)}catch{this.validationErrors[t]=a.translator.trans("wusong8899-tournament-widget.admin.validation.invalid_url")}r.redraw()}validateAndSetDate(t){if(!t.trim()){delete this.validationErrors.start_date,this.setting("wusong8899_tournament.start_date")(t);return}try{const e=new Date(t);if(isNaN(e.getTime()))throw new Error("Invalid date");const s=e.toISOString();delete this.validationErrors.start_date,this.setting("wusong8899_tournament.start_date")(s)}catch{this.validationErrors.start_date=a.translator.trans("wusong8899-tournament-widget.admin.validation.invalid_date")}r.redraw()}formatDateForInput(t){if(!t)return"";try{const e=new Date(t);if(isNaN(e.getTime()))return"";const s=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),d=String(e.getMinutes()).padStart(2,"0"),u=String(e.getSeconds()).padStart(2,"0");return`${s}-${n}-${o}T${i}:${d}:${u}`}catch{return""}}saveSettings(t){this.validationErrors={};let e=!1;const s=this.setting("wusong8899_tournament.details_url")();if(s&&s.trim())try{new URL(s)}catch{this.validationErrors.details_url=a.translator.trans("wusong8899-tournament-widget.admin.validation.invalid_url"),e=!0}const n=this.setting("wusong8899_tournament.background_image")();if(n&&n.trim())try{new URL(n)}catch{this.validationErrors.background_image=a.translator.trans("wusong8899-tournament-widget.admin.validation.invalid_url"),e=!0}const o=this.setting("wusong8899_tournament.header_image")();if(o&&o.trim())try{new URL(o)}catch{this.validationErrors.header_image=a.translator.trans("wusong8899-tournament-widget.admin.validation.invalid_url"),e=!0}return e?(a.alerts.show({type:"error"},a.translator.trans("wusong8899-tournament-widget.admin.validation.fix_errors")),r.redraw(),Promise.resolve()):super.saveSettings(t).then(()=>{},i=>{console.error("Settings save error:",i);const d=i?.response?.errors?.[0]?.detail||a.translator.trans("wusong8899-tournament-widget.admin.settings.save_error");a.alerts.show({type:"error"},d)})}}a.initializers.add("wusong8899-tournament-widget",()=>{a.extensionData.for("wusong8899-tournament-widget").registerPage(T).registerPermission({icon:"fas fa-trophy",label:a.translator.trans("wusong8899-tournament-widget.admin.permissions.participate"),permission:"tournament.participate"},"start").registerPermission({icon:"fas fa-cog",label:a.translator.trans("wusong8899-tournament-widget.admin.permissions.manage_platforms"),permission:"tournament.managePlatforms"},"moderate")})})(flarum.core.compat["admin/app"],flarum.core.compat["admin/components/ExtensionPage"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/LoadingIndicator"],flarum.core.compat["common/utils/Stream"],m,flarum.core.compat["common/Component"],flarum.core.compat["common/components/Switch"]);
//# sourceMappingURL=admin.js.map

module.exports={};