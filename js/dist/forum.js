(function(e,g,r,i,p,l,w,d,u){"use strict";class f{view({attrs:a}){const{platform:t,size:o="medium"}=a;if(!t)return d("fas fa-gamepad",{className:`PlatformIcon PlatformIcon--${o}`});const s=`PlatformIcon PlatformIcon--${o}`;return t.iconUrl?m("img",{src:t.iconUrl,alt:t.name,className:s}):t.iconClass?d(t.iconClass,{className:s}):d("fas fa-gamepad",{className:s})}}class N extends i{oninit(a){super.oninit(a),this.state={showDropdown:!1}}view(){const{selectedPlatform:a}=this.attrs,{showDropdown:t}=this.state;return m("div",{className:"TournamentPlatformSelector"},m("div",{className:"TournamentPlatformSelector-label"},"游戏平台"),m("div",{className:"TournamentPlatformSelector-dropdown",onclick:()=>this.toggleDropdown()},m("div",{className:"TournamentPlatformSelector-selected"},m("div",{className:"TournamentPlatformSelector-info"},m("div",{className:"TournamentPlatformSelector-icon"},m(f,{platform:a,size:"medium"})),m("div",{className:"TournamentPlatformSelector-details"},m("div",{className:"TournamentPlatformSelector-name"},this.getPlatformName(a))))),d("fas fa-chevron-down",{className:"TournamentPlatformSelector-dropdownIcon"})),t&&this.renderPlatformDropdown())}toggleDropdown(){this.state.showDropdown=!this.state.showDropdown}getPlatformName(a){return a&&a.name||"请选择游戏平台"}renderPlatformDropdown(){const{platforms:a}=this.attrs;return!a||a.length===0?m("div",{className:"TournamentPlatformSelector-dropdownMenu"},m("div",{className:"TournamentPlatformSelector-dropdownItem TournamentPlatformSelector-noData"},"暂无可选平台")):m("div",{className:"TournamentPlatformSelector-dropdownMenu"},a.map(t=>m("div",{key:t.id,className:"TournamentPlatformSelector-dropdownItem",onclick:()=>this.selectPlatform(t)},m("div",{className:"TournamentPlatformSelector-icon"},m(f,{platform:t,size:"small"})),m("div",{className:"TournamentPlatformSelector-name"},t.name))))}selectPlatform(a){const{onPlatformSelect:t}=this.attrs;t(a),this.state.showDropdown=!1}}class v extends w{constructor(){super(...arguments),this.platformAccount="",this.platformUsername="",this.selectedPlatform=null,this.platforms=[],this.loading=!1,this.loadingPlatforms=!0,this.errors={}}oninit(a){super.oninit(a),this.loadPlatforms()}className(){return"ParticipateModal Modal--small"}title(){return e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.title")}content(){return this.loadingPlatforms?r("div",{className:"Modal-body"},r("div",{className:"LoadingIndicator"}),r("p",null,"加载平台信息中...")):r("div",{className:"Modal-body"},r("div",{className:"Form"},r("div",{className:"Form-group"},r(N,{platforms:this.platforms,selectedPlatform:this.selectedPlatform,onPlatformSelect:a=>this.onPlatformSelect(a)}),this.errors.platform&&r("div",{className:"Alert Alert--error",style:{marginTop:"8px"}},this.errors.platform),this.errors.platformId&&r("div",{className:"Alert Alert--error",style:{marginTop:"8px"}},this.errors.platformId)),r("div",{className:"Form-group"},r("label",{className:"FormLabel"},"平台用户名"),r("input",{className:this.errors.platformUsername?"FormControl FormControl--error":"FormControl",type:"text",placeholder:"请输入您在该平台的用户名（支持中文、英文、数字等任意字符）",value:this.platformUsername,oninput:a=>{this.platformUsername=a.target.value,this.errors.platformUsername&&(delete this.errors.platformUsername,r.redraw())}}),this.errors.platformUsername&&r("div",{className:"Alert Alert--error",style:{marginTop:"8px"}},this.errors.platformUsername)),r("div",{className:"Form-group"},r(l,{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.selectedPlatform||!this.platformUsername.trim(),onclick:this.onsubmit.bind(this)},e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.submit")))))}onsubmit(a){if(a.preventDefault(),this.errors={},this.selectedPlatform||(this.errors.platform=e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.platform_required")),this.platformUsername.trim()||(this.errors.platformUsername=e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.username_required")),Object.keys(this.errors).length>0){r.redraw();return}this.loading=!0,e.request({method:"POST",url:e.forum.attribute("apiUrl")+"/tournament/participate",body:{data:{attributes:{platformId:this.selectedPlatform.id,platformUsername:this.platformUsername.trim(),platformAccount:this.platformUsername.trim()}}}}).then(()=>{this.hide(),e.alerts.show({type:"success"},e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.success")),this.attrs.onParticipate?.()},t=>{this.loading=!1,this.handleError(t),r.redraw()})}loadPlatforms(){e.request({method:"GET",url:e.forum.attribute("apiUrl")+"/tournament/platforms"}).then(a=>{this.platforms=a.data.map(t=>({id:t.id,name:t.attributes.name,iconUrl:t.attributes.iconUrl,iconClass:t.attributes.iconClass,isActive:t.attributes.isActive,displayOrder:t.attributes.displayOrder})),this.loadingPlatforms=!1,r.redraw()},a=>{console.error("Failed to load platforms:",a),this.loadingPlatforms=!1,e.alerts.show({type:"error"},"加载平台信息失败"),r.redraw()})}onPlatformSelect(a){this.selectedPlatform=a,this.platformUsername="",delete this.errors.platform,delete this.errors.platformId}handleError(a){if(this.errors={},a?.response?.errors)a.response.errors.forEach(o=>{if(o.source?.pointer){const s=o.source.pointer.replace("/data/attributes/","");this.errors[s]=o.detail||o.title}else e.alerts.show({type:"error"},o.detail||o.title||e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.error"))});else if(a?.response?.data?.errors){const t=a.response.data.errors;Object.keys(t).forEach(o=>{this.errors[o]=t[o][0]})}else{const t=a?.response?.data?.message||a?.message||e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.error");e.alerts.show({type:"error"},t)}}}class b extends i{view(a){const{title:t,prizePool:o,detailsUrl:s,backgroundImage:S,timeElapsed:c,userParticipated:h,onParticipate:U}=a.attrs;return m("div",{className:"TournamentCard",style:{backgroundImage:`url(${S})`}},m("a",{className:"TournamentCard-detailsLink",href:s,target:"_blank",rel:"noopener noreferrer"},e.translator.trans("wusong8899-tournament-widget.forum.tournament.details")),m("div",{className:"TournamentCard-content"},m("div",{className:"TournamentCard-title"},t),m("div",{className:"TournamentCard-prizePool"},m("label",null,e.translator.trans("wusong8899-tournament-widget.forum.tournament.prize_pool")),m("span",null,o)),m("div",{className:"Timer"},m("label",null,e.translator.trans("wusong8899-tournament-widget.forum.tournament.started_at")),m("div",{className:"Timer-display"},m("div",{className:"Timer-boxes"},m("div",{className:"Timer-unit"},m("strong",null,c.days)),m("span",{className:"Timer-separator"},":"),m("div",{className:"Timer-unit"},m("strong",null,c.hours)),m("span",{className:"Timer-separator"},":"),m("div",{className:"Timer-unit"},m("strong",null,c.mins)),m("span",{className:"Timer-separator"},":"),m("div",{className:"Timer-unit"},m("strong",null,c.secs))),m("div",{className:"Timer-labels"},m("div",{className:"Timer-label"},"DAYS"),m("span",{className:"Timer-spacer"}),m("div",{className:"Timer-label"},"HRS"),m("span",{className:"Timer-spacer"}),m("div",{className:"Timer-label"},"MINS"),m("span",{className:"Timer-spacer"}),m("div",{className:"Timer-label"},"SECS")))),!h&&e.session.user&&m(l,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>{e.modal.show(v,{onParticipate:U})}},e.translator.trans("wusong8899-tournament-widget.forum.tournament.participate_now")),h&&m("div",{className:"TournamentCard-participated"},m("i",{className:"fas fa-check-circle"})," ",e.translator.trans("wusong8899-tournament-widget.forum.tournament.participated")),!e.session.user&&m(l,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>e.route("login")},e.translator.trans("wusong8899-tournament-widget.forum.tournament.login_to_participate"))))}}class T extends i{constructor(){super(...arguments),this.showAll=!1}view(a){const{participants:t}=a.attrs,o=this.showAll?t:t.slice(0,5);return m("div",{className:"Leaderboard"},m("div",{className:"Leaderboard-header"},m("div",{className:"Leaderboard-headerRow"},m("div",{className:"Leaderboard-headerCell rank"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.rank")),m("div",{className:"Leaderboard-headerCell title"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.rank_title")),m("div",{className:"Leaderboard-headerCell user"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.user")),m("div",{className:"Leaderboard-headerCell platform"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.platform")),m("div",{className:"Leaderboard-headerCell score"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.amount")))),m("div",{className:"Leaderboard-list"},o.length>0?o.map(s=>m("div",{className:`Leaderboard-item rank-${s.rank}`,key:s.id},m("div",{className:"Leaderboard-cell rank"},m("i",{className:this.getRankIcon(s.rank)}),m("span",{className:"rank-number"},s.rank)),m("div",{className:"Leaderboard-cell title"},m("span",{className:"title-text"},s.title)),m("div",{className:"Leaderboard-cell user"},m("div",{className:"user-info"},s.user.avatarUrl&&m("img",{className:"user-avatar",src:s.user.avatarUrl,alt:s.user.displayName}),m("span",{className:"user-name"},s.user.displayName))),m("div",{className:"Leaderboard-cell platform"},m("div",{className:"platform-info"},this.renderPlatformIcon(s.platform),m("div",{className:"platform-details"},m("div",{className:"platform-name"},s.platform.name),m("div",{className:"platform-username"},s.platform.username)))),m("div",{className:"Leaderboard-cell score"},m("span",{className:"score-amount"},s.amount)))):m("div",{className:"Leaderboard-empty"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.no_participants"))),!this.showAll&&t.length>5&&m(l,{className:"Button Button--block Leaderboard-expandBtn",onclick:()=>{this.showAll=!0}},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.view_all",{count:t.length})),this.showAll&&t.length>5&&m(l,{className:"Button Button--block Leaderboard-collapseBtn",onclick:()=>{this.showAll=!1}},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.collapse")))}getRankIcon(a){return a===1?"fas fa-crown rank-gold":a===2?"fas fa-crown rank-silver":a===3?"fas fa-crown rank-bronze":"fas fa-medal"}renderPlatformIcon(a){return a.usesUrlIcon&&a.iconUrl?m("img",{className:"platform-icon image-icon",src:a.iconUrl,alt:a.name}):a.usesCssIcon&&a.iconClass?m("i",{className:`platform-icon css-icon ${a.iconClass}`}):m("i",{className:"platform-icon css-icon fas fa-gamepad"})}}function P(n){const a=Math.floor(n/1e3),t=Math.floor(a/60),o=Math.floor(t/60),s=Math.floor(o/24);return{days:String(s).padStart(2,"0"),hours:String(o%24).padStart(2,"0"),mins:String(t%60).padStart(2,"0"),secs:String(a%60).padStart(2,"0")}}class D extends i{constructor(){super(...arguments),this.loading=!0,this.tournamentData=null,this.timerInterval=null,this.animationFrame=null,this.timeElapsed={days:"00",hours:"00",mins:"00",secs:"00"},this.lastUpdateTime=0}oninit(a){super.oninit(a),this.loadData()}oncreate(a){super.oncreate(a),this.startTimer()}onremove(a){super.onremove(a),this.timerInterval&&clearInterval(this.timerInterval),this.animationFrame&&cancelAnimationFrame(this.animationFrame)}view(){return this.loading?r("div",{className:"TournamentWidget"},r("div",{className:"TournamentWidget-loading"},r(p,null))):this.tournamentData?r("div",{className:"TournamentWidget"},r("div",{className:"TournamentHeader"},r("img",{className:"TournamentHeader-image",src:this.tournamentData.headerImage||"https://i.mji.rip/2025/08/23/678aa40f68db12909bb4a4871d603876.webp",alt:"Tournament"}),r("span",{className:"TournamentHeader-title"},this.tournamentData.headerTitle||"老哥榜")),r(b,{title:this.tournamentData.title,prizePool:this.tournamentData.prizePool,detailsUrl:this.tournamentData.detailsUrl,backgroundImage:this.tournamentData.backgroundImage,timeElapsed:this.timeElapsed,userParticipated:this.tournamentData.userParticipated,onParticipate:()=>this.loadData()}),r(T,{participants:this.tournamentData.participants})):null}startTimer(){if(!this.tournamentData?.startDate)return;const a=new Date(this.tournamentData.startDate);this.lastUpdateTime=Date.now();const t=()=>{const o=Date.now();if(o-this.lastUpdateTime>=1e3){const s=o-a.getTime();s>0&&(this.timeElapsed=P(s),this.lastUpdateTime=o,r.redraw())}this.animationFrame=requestAnimationFrame(t)};this.animationFrame=requestAnimationFrame(t)}loadData(){return this.loading=!0,e.request({method:"GET",url:e.forum.attribute("apiUrl")+"/tournament"}).then(a=>{this.tournamentData={title:a.data.attributes.title,prizePool:a.data.attributes.prizePool,startDate:a.data.attributes.startDate,detailsUrl:a.data.attributes.detailsUrl,backgroundImage:a.data.attributes.backgroundImage,headerTitle:a.data.attributes.headerTitle,headerImage:a.data.attributes.headerImage,userParticipated:a.data.attributes.userParticipated,totalParticipants:a.data.attributes.totalParticipants,participants:a.data.attributes.participants||[]},this.loading=!1,this.timerInterval||this.startTimer(),r.redraw()}).catch(a=>{this.loading=!1,console.error("Failed to load tournament data:",a),r.redraw()})}}e.initializers.add("wusong8899-tournament-widget",()=>{u?g.extend(u.prototype,"content",function(n){const a=n.children;Array.isArray(a)&&a.push(r(D))}):console.warn("TagsPage not found - tournament widget will not be injected")})})(flarum.core.compat["forum/app"],flarum.core.compat["common/extend"],m,flarum.core.compat["common/Component"],flarum.core.compat["common/components/LoadingIndicator"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/helpers/icon"],flarum.core.compat["tags/forum/components/TagsPage"]);
//# sourceMappingURL=forum.js.map

module.exports={};