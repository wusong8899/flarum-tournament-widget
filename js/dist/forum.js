(function(t,p,a,l,h,d,T,u,g,P,v,N){"use strict";class w{view({attrs:e}){const{platform:r,size:s="medium"}=e;if(!r)return u("fas fa-gamepad",{className:`PlatformIcon PlatformIcon--${s}`});const n=`PlatformIcon PlatformIcon--${s}`;return r.iconUrl?m("img",{src:r.iconUrl,alt:r.name,className:n}):r.iconClass?u(r.iconClass,{className:n}):u("fas fa-gamepad",{className:n})}}class k extends l{oninit(e){super.oninit(e),this.state={showDropdown:!1}}view(){const{selectedPlatform:e}=this.attrs,{showDropdown:r}=this.state;return m("div",{className:"TournamentPlatformSelector"},m("div",{className:"TournamentPlatformSelector-label"},"游戏平台"),m("div",{className:"TournamentPlatformSelector-dropdown",onclick:()=>this.toggleDropdown()},m("div",{className:"TournamentPlatformSelector-selected"},m("div",{className:"TournamentPlatformSelector-info"},m("div",{className:"TournamentPlatformSelector-icon"},m(w,{platform:e,size:"medium"})),m("div",{className:"TournamentPlatformSelector-details"},m("div",{className:"TournamentPlatformSelector-name"},this.getPlatformName(e))))),u("fas fa-chevron-down",{className:"TournamentPlatformSelector-dropdownIcon"})),r&&this.renderPlatformDropdown())}toggleDropdown(){this.state.showDropdown=!this.state.showDropdown}getPlatformName(e){return e&&e.name||"请选择游戏平台"}renderPlatformDropdown(){const{platforms:e}=this.attrs;return!e||e.length===0?m("div",{className:"TournamentPlatformSelector-dropdownMenu"},m("div",{className:"TournamentPlatformSelector-dropdownItem TournamentPlatformSelector-noData"},"暂无可选平台")):m("div",{className:"TournamentPlatformSelector-dropdownMenu"},e.map(r=>m("div",{key:r.id,className:"TournamentPlatformSelector-dropdownItem",onclick:()=>this.selectPlatform(r)},m("div",{className:"TournamentPlatformSelector-icon"},m(w,{platform:r,size:"small"})),m("div",{className:"TournamentPlatformSelector-name"},r.name))))}selectPlatform(e){const{onPlatformSelect:r}=this.attrs;r(e),this.state.showDropdown=!1}}class y extends T{constructor(){super(...arguments),this.platformAccount="",this.platformUsername="",this.selectedPlatform=null,this.platforms=[],this.loading=!1,this.loadingPlatforms=!0,this.errors={}}oninit(e){super.oninit(e),this.loadPlatforms()}className(){return"ParticipateModal Modal--small"}title(){return t.translator.trans("wusong8899-tournament-widget.forum.participate_modal.title")}content(){return this.loadingPlatforms?a("div",{className:"Modal-body"},a("div",{className:"LoadingIndicator"}),a("p",null,"加载平台信息中...")):a("div",{className:"Modal-body"},a("div",{className:"Form"},a("div",{className:"Form-group"},a(k,{platforms:this.platforms,selectedPlatform:this.selectedPlatform,onPlatformSelect:e=>this.onPlatformSelect(e)}),this.errors.platform&&a("div",{className:"Alert Alert--error",style:{marginTop:"8px"}},this.errors.platform),this.errors.platformId&&a("div",{className:"Alert Alert--error",style:{marginTop:"8px"}},this.errors.platformId)),a("div",{className:"Form-group"},a("label",{className:"FormLabel"},"平台用户名"),a("input",{className:this.errors.platformUsername?"FormControl FormControl--error":"FormControl",type:"text",placeholder:"请输入您在该平台的用户名（支持中文、英文、数字等任意字符）",value:this.platformUsername,oninput:e=>{this.platformUsername=e.target.value,this.errors.platformUsername&&(delete this.errors.platformUsername,a.redraw())}}),this.errors.platformUsername&&a("div",{className:"Alert Alert--error",style:{marginTop:"8px"}},this.errors.platformUsername)),a("div",{className:"Form-group"},a(d,{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.selectedPlatform||!this.platformUsername.trim(),onclick:this.onsubmit.bind(this)},t.translator.trans("wusong8899-tournament-widget.forum.participate_modal.submit")))))}onsubmit(e){if(e.preventDefault(),this.errors={},this.selectedPlatform||(this.errors.platform=t.translator.trans("wusong8899-tournament-widget.forum.participate_modal.platform_required")),this.platformUsername.trim()||(this.errors.platformUsername=t.translator.trans("wusong8899-tournament-widget.forum.participate_modal.username_required")),Object.keys(this.errors).length>0){a.redraw();return}this.loading=!0,t.request({method:"POST",url:t.forum.attribute("apiUrl")+"/tournament/participate",body:{data:{attributes:{platformId:this.selectedPlatform.id,platformUsername:this.platformUsername.trim(),platformAccount:this.platformUsername.trim()}}}}).then(()=>{this.loading=!1,t.modal.close(),t.alerts.show({type:"success"},t.translator.trans("wusong8899-tournament-widget.forum.participate_modal.success")),this.attrs.onParticipate?.()},r=>{this.loading=!1,this.handleError(r),a.redraw()})}loadPlatforms(){t.request({method:"GET",url:t.forum.attribute("apiUrl")+"/tournament/platforms"}).then(e=>{this.platforms=e.data.map(r=>({id:r.id,name:r.attributes.name,iconUrl:r.attributes.iconUrl,iconClass:r.attributes.iconClass,isActive:r.attributes.isActive,displayOrder:r.attributes.displayOrder})),this.loadingPlatforms=!1,a.redraw()},e=>{console.error("Failed to load platforms:",e),this.loadingPlatforms=!1,t.alerts.show({type:"error"},"加载平台信息失败"),a.redraw()})}onPlatformSelect(e){this.selectedPlatform=e,this.platformUsername="",delete this.errors.platform,delete this.errors.platformId}handleError(e){if(this.errors={},e?.response?.errors)e.response.errors.forEach(s=>{if(s.source?.pointer){const n=s.source.pointer.replace("/data/attributes/","");this.errors[n]=s.detail||s.title}else t.alerts.show({type:"error"},s.detail||s.title||t.translator.trans("wusong8899-tournament-widget.forum.participate_modal.error"))});else if(e?.response?.data?.errors){const r=e.response.data.errors;Object.keys(r).forEach(s=>{this.errors[s]=r[s][0]})}else{const r=e?.response?.data?.message||e?.message||t.translator.trans("wusong8899-tournament-widget.forum.participate_modal.error");t.alerts.show({type:"error"},r)}}}class U extends l{view(e){const{title:r,prizePool:s,detailsUrl:n,backgroundImage:c,timeElapsed:o,userParticipated:b,userApplicationStatus:f,onParticipate:C}=e.attrs;return m("div",{className:"TournamentCard",style:{background:`url(${c}) center/cover no-repeat, linear-gradient(75.2deg, #2129a7 0.57%, #132cd1 72.59%)`}},m("div",{className:"TournamentCard-header"},m("div",{className:"TournamentCard-title"},r),m("a",{className:"TournamentCard-detailsLink",href:n,target:"_blank",rel:"noopener noreferrer"},t.translator.trans("wusong8899-tournament-widget.forum.tournament.details")),m("div",{className:"TournamentCard-prizePool"},m("label",null,t.translator.trans("wusong8899-tournament-widget.forum.tournament.prize_pool")),m("span",null,s))),m("div",{className:"TournamentCard-content"},m("div",{className:"TournamentCard-contentRow"},m("div",{className:"Timer"},m("label",null,t.translator.trans("wusong8899-tournament-widget.forum.tournament.started_at")),m("div",{className:"Timer-display"},m("div",{className:"Timer-boxes"},m("div",{className:"Timer-unit"},m("strong",null,o.days)),m("span",{className:"Timer-separator"},":"),m("div",{className:"Timer-unit"},m("strong",null,o.hours)),m("span",{className:"Timer-separator"},":"),m("div",{className:"Timer-unit"},m("strong",null,o.mins)),m("span",{className:"Timer-separator"},":"),m("div",{className:"Timer-unit"},m("strong",null,o.secs))),m("div",{className:"Timer-labels"},m("div",{className:"Timer-label"},"DAYS"),m("span",{className:"Timer-spacer"}),m("div",{className:"Timer-label"},"HRS"),m("span",{className:"Timer-spacer"}),m("div",{className:"Timer-label"},"MINS"),m("span",{className:"Timer-spacer"}),m("div",{className:"Timer-label"},"SECS")))),m("div",{className:"TournamentCard-actions"},!b&&t.session.user&&m(d,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>{t.modal.show(y,{onParticipate:C})}},t.translator.trans("wusong8899-tournament-widget.forum.tournament.participate_now")),b&&f&&m("div",{className:`TournamentCard-status ${f.isApproved?"approved":"pending"}`},f.isApproved?m("[",null,m("i",{className:"fas fa-check-circle"}),t.translator.trans("wusong8899-tournament-widget.forum.tournament.approved")):m("[",null,m("i",{className:"fas fa-clock"}),t.translator.trans("wusong8899-tournament-widget.forum.tournament.pending_approval"))),!t.session.user&&m(d,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>t.route("login")},t.translator.trans("wusong8899-tournament-widget.forum.tournament.login_to_participate"))))))}}class I extends l{constructor(){super(...arguments),this.containerRef=null}oncreate(e){super.oncreate(e),this.containerRef=e.dom,this.observeResize()}onremove(){this.resizeObserver&&this.resizeObserver.disconnect()}observeResize(){!this.containerRef||typeof ResizeObserver>"u"||(this.resizeObserver=new ResizeObserver(e=>{for(let r of e){const s=r.contentRect.width;s<640?(this.containerRef?.classList.add("compact-view"),this.containerRef?.classList.remove("wide-view")):s>1200?(this.containerRef?.classList.add("wide-view"),this.containerRef?.classList.remove("compact-view")):this.containerRef?.classList.remove("compact-view","wide-view")}}),this.resizeObserver.observe(this.containerRef))}view(e){const{participants:r}=e.attrs,s=t.forum.attribute("wusong8899_tournament.preview_limit"),n=s?parseInt(s):5,c=r.slice(0,n);return a("div",{className:"Leaderboard"},a("div",{className:"Leaderboard-header"},a("div",{className:"Leaderboard-headerRow"},a("div",{className:"Leaderboard-headerCell rank"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.rank")),a("div",{className:"Leaderboard-headerCell user"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.user")),a("div",{className:"Leaderboard-headerCell platform"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.platform")),a("div",{className:"Leaderboard-headerCell score"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.amount")))),a("div",{className:"Leaderboard-list"},c.length>0?c.map(o=>a("div",{className:`Leaderboard-item rank-${o.rank}`,key:o.id,"data-rank":`#${o.rank}`,title:`${o.user.displayName} - ${o.title}`},a("div",{className:"Leaderboard-cell rank"},a("i",{className:this.getRankIcon(o.rank)}),a("span",{className:"rank-number"},o.rank)),a("div",{className:"Leaderboard-cell user"},a("div",{className:"user-info"},this.renderUserAvatar(o.user),a("div",{className:"user-details"},a("span",{className:"user-name"},o.user.displayName),a("span",{className:"user-title"},o.title)))),a("div",{className:"Leaderboard-cell platform"},a("div",{className:"platform-info"},this.renderPlatformIcon(o.platform),a("div",{className:"platform-details"},a("div",{className:"platform-name"},o.platform.name),a("div",{className:"platform-username"},o.platform.username)))),a("div",{className:"Leaderboard-cell score"},a("span",{className:`score-amount ${o.amount<0?"negative":o.amount>0?"positive":"zero"}`},o.amount)))):a("div",{className:"Leaderboard-empty"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.no_participants"))),r.length>n&&a(d,{className:"Button Button--block Leaderboard-detailsBtn",onclick:()=>{a.route.set("/tournament/rankings")}},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.view_details")))}getRankIcon(e){return e===1?"fas fa-crown rank-gold":e===2?"fas fa-crown rank-silver":e===3?"fas fa-crown rank-bronze":"fas fa-medal"}renderUserAvatar(e){const r=t.store.getById("users",e.id);return r?g(r,{className:"user-avatar"}):e.avatarUrl?a("img",{className:"user-avatar",src:e.avatarUrl,alt:e.displayName}):a("div",{className:"user-avatar user-avatar--default"},a("i",{className:"fas fa-user"}))}renderPlatformIcon(e){return e.usesUrlIcon&&e.iconUrl?a("img",{className:"platform-icon image-icon",src:e.iconUrl,alt:e.name}):e.usesCssIcon&&e.iconClass?a("i",{className:`platform-icon css-icon ${e.iconClass}`}):a("i",{className:"platform-icon css-icon fas fa-gamepad"})}}function L(i){const e=Math.floor(i/1e3),r=Math.floor(e/60),s=Math.floor(r/60),n=Math.floor(s/24);return{days:String(n).padStart(2,"0"),hours:String(s%24).padStart(2,"0"),mins:String(r%60).padStart(2,"0"),secs:String(e%60).padStart(2,"0")}}class S extends l{constructor(){super(...arguments),this.loading=!0,this.tournamentData=null,this.timerInterval=null,this.animationFrame=null,this.timeElapsed={days:"00",hours:"00",mins:"00",secs:"00"},this.lastUpdateTime=0}oninit(e){super.oninit(e),this.loadData()}oncreate(e){super.oncreate(e),this.startTimer()}onremove(e){super.onremove(e),this.timerInterval&&clearInterval(this.timerInterval),this.animationFrame&&cancelAnimationFrame(this.animationFrame)}view(){return this.loading?a("div",{className:"TournamentWidget"},a("div",{className:"TournamentWidget-loading"},a(h,null))):this.tournamentData?a("div",{className:"TournamentWidget"},a("div",{className:"TournamentHeader"},a("img",{className:"TournamentHeader-image",src:this.tournamentData.headerImage||"https://i.mji.rip/2025/08/23/678aa40f68db12909bb4a4871d603876.webp",alt:"Tournament"}),a("span",{className:"TournamentHeader-title"},this.tournamentData.headerTitle||"老哥榜")),a(U,{title:this.tournamentData.title,prizePool:this.tournamentData.prizePool,detailsUrl:this.tournamentData.detailsUrl,backgroundImage:this.tournamentData.backgroundImage,timeElapsed:this.timeElapsed,userParticipated:this.tournamentData.userParticipated,userApplicationStatus:this.tournamentData.userApplicationStatus,onParticipate:()=>this.loadData()}),a(I,{participants:this.tournamentData.participants})):null}startTimer(){if(!this.tournamentData?.startDate)return;const e=new Date(this.tournamentData.startDate);this.lastUpdateTime=Date.now();const r=()=>{const s=Date.now();if(s-this.lastUpdateTime>=1e3){const n=s-e.getTime();n>0&&(this.timeElapsed=L(n),this.lastUpdateTime=s,a.redraw())}this.animationFrame=requestAnimationFrame(r)};this.animationFrame=requestAnimationFrame(r)}loadData(){return this.loading=!0,t.request({method:"GET",url:t.forum.attribute("apiUrl")+"/tournament"}).then(e=>{this.tournamentData={title:e.data.attributes.title,prizePool:e.data.attributes.prizePool,startDate:e.data.attributes.startDate,detailsUrl:e.data.attributes.detailsUrl,backgroundImage:e.data.attributes.backgroundImage,headerTitle:e.data.attributes.headerTitle,headerImage:e.data.attributes.headerImage,userParticipated:e.data.attributes.userParticipated,userApplicationStatus:e.data.attributes.userApplicationStatus,totalParticipants:e.data.attributes.totalParticipants,participants:e.data.attributes.participants||[]},this.loading=!1,this.timerInterval||this.startTimer(),a.redraw()}).catch(e=>{this.loading=!1,console.error("Failed to load tournament data:",e),a.redraw()})}}class D extends P{constructor(){super(...arguments),this.loading=!0,this.tournamentData=null,this.error=null}oninit(e){super.oninit(e),t.setTitle(t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.full_rankings_title")),this.loadTournamentData()}async loadTournamentData(){try{this.loading=!0,m.redraw();const e=await t.request({method:"GET",url:`${t.forum.attribute("apiUrl")}/tournament`});if(e&&e.data&&e.data.attributes)this.tournamentData=e.data.attributes,this.error=null;else throw new Error("Invalid response format")}catch(e){console.error("Failed to load tournament data:",e),this.error="Failed to load tournament data"}finally{this.loading=!1,m.redraw()}}view(){return m("div",{className:"TournamentRankingsPage"},this.content())}content(){if(this.loading)return m(h,null);if(this.error||!this.tournamentData)return m("div",{className:"container"},m("div",{className:"TournamentRankingsPage-error"},m("h2",null,t.translator.trans("core.forum.error.generic_message")),m("p",null,this.error||"Tournament data not available"),m(v,{href:"/",className:"Button Button--primary"},t.translator.trans("core.forum.error.return_link"))));const{tournamentData:e}=this;return m("div",{className:"container"},m("div",{className:"TournamentRankingsPage-header"},m("div",{className:"TournamentRankingsPage-navigation"},m(v,{href:"/",className:"Button Button--text"},m("i",{className:"fas fa-arrow-left"}),t.translator.trans("core.forum.header.back_to_index_tooltip"))),m("h1",{className:"TournamentRankingsPage-title"},e.headerTitle||t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.full_rankings_title")),m("div",{className:"TournamentRankingsPage-tournamentInfo"},m("h2",null,e.title),m("p",{className:"TournamentRankingsPage-prizePool"},t.translator.trans("wusong8899-tournament-widget.forum.tournament.prize_pool"),": ",e.prizePool))),m("div",{className:"TournamentRankingsPage-leaderboard"},this.renderFullLeaderboard()))}renderFullLeaderboard(){return!this.tournamentData||!this.tournamentData.participants.length?m("div",{className:"TournamentRankingsPage-empty"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.no_participants")):m("div",{className:"Leaderboard Leaderboard--fullPage"},m("div",{className:"Leaderboard-header"},m("div",{className:"Leaderboard-headerRow"},m("div",{className:"Leaderboard-headerCell rank"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.rank")),m("div",{className:"Leaderboard-headerCell user"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.user")),m("div",{className:"Leaderboard-headerCell platform"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.platform")),m("div",{className:"Leaderboard-headerCell score"},t.translator.trans("wusong8899-tournament-widget.forum.leaderboard.amount")))),m("div",{className:"Leaderboard-list"},this.tournamentData.participants.map(e=>m("div",{className:`Leaderboard-item rank-${e.rank}`,key:e.id,"data-rank":`#${e.rank}`,title:`${e.user.displayName} - ${e.title}`},m("div",{className:"Leaderboard-cell rank"},m("i",{className:this.getRankIcon(e.rank)}),m("span",{className:"rank-number"},e.rank)),m("div",{className:"Leaderboard-cell user"},m("div",{className:"user-info"},this.renderUserAvatar(e.user),m("div",{className:"user-details"},m("span",{className:"user-name"},e.user.displayName),m("span",{className:"user-title"},e.title)))),m("div",{className:"Leaderboard-cell platform"},m("div",{className:"platform-info"},this.renderPlatformIcon(e.platform),m("div",{className:"platform-details"},m("div",{className:"platform-name"},e.platform.name),m("div",{className:"platform-username"},e.platform.username)))),m("div",{className:"Leaderboard-cell score"},m("span",{className:`score-amount ${e.amount<0?"negative":e.amount>0?"positive":"zero"}`},e.amount))))))}getRankIcon(e){return e===1?"fas fa-crown rank-gold":e===2?"fas fa-crown rank-silver":e===3?"fas fa-crown rank-bronze":"fas fa-medal"}renderUserAvatar(e){const r=t.store.getById("users",e.id);return r?g(r,{className:"user-avatar"}):e.avatarUrl?m("img",{className:"user-avatar",src:e.avatarUrl,alt:e.displayName}):m("div",{className:"user-avatar user-avatar--default"},m("i",{className:"fas fa-user"}))}renderPlatformIcon(e){return e.usesUrlIcon&&e.iconUrl?m("img",{className:"platform-icon image-icon",src:e.iconUrl,alt:e.name}):e.usesCssIcon&&e.iconClass?m("i",{className:`platform-icon css-icon ${e.iconClass}`}):m("i",{className:"platform-icon css-icon fas fa-gamepad"})}}t.initializers.add("wusong8899-tournament-widget",()=>{t.routes["tournament.rankings"]={path:"/tournament/rankings",component:D},N?p.extend(N.prototype,"content",function(i){const e=i.children;Array.isArray(e)&&e.push(a(S))}):console.warn("TagsPage not found - tournament widget will not be injected")})})(flarum.core.compat["forum/app"],flarum.core.compat["common/extend"],m,flarum.core.compat["common/Component"],flarum.core.compat["common/components/LoadingIndicator"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/helpers/icon"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/components/Page"],flarum.core.compat["common/components/LinkButton"],flarum.core.compat["tags/forum/components/TagsPage"]);
//# sourceMappingURL=forum.js.map

module.exports={};