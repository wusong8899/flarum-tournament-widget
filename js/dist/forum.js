(function(s,h,c,p,l,f,d){"use strict";class g extends f{constructor(){super(...arguments),this.platformAccount="",this.loading=!1}className(){return"ParticipateModal Modal--small"}title(){return"参加活动"}content(){return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",{className:"FormLabel"},"平台账号"),m("input",{className:"FormControl",type:"text",placeholder:"请输入您的平台账号",value:this.platformAccount,oninput:t=>{this.platformAccount=t.target.value}})),m("div",{className:"Form-group"},m(l,{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.platformAccount.trim(),onclick:this.onsubmit.bind(this)},"提交"))))}onsubmit(t){t.preventDefault(),this.platformAccount.trim()&&(this.loading=!0,s.request({method:"POST",url:s.forum.attribute("apiUrl")+"/tournament/participate",body:{data:{attributes:{platformAccount:this.platformAccount.trim()}}}}).then(()=>{this.hide(),s.alerts.show("success","参加成功！"),m.redraw()},a=>{var r,n,o;this.loading=!1;const e=((o=(n=(r=a==null?void 0:a.response)==null?void 0:r.errors)==null?void 0:n[0])==null?void 0:o.detail)||"参加失败，请重试";s.alerts.show("error",e)}))}}class b extends c{view(t){const{title:a,prizePool:e,detailsUrl:r,backgroundImage:n,timeElapsed:o,userParticipated:u,onParticipate:T}=t.attrs;return m("div",{className:"TournamentCard",style:{backgroundImage:`url(${n})`}},m("a",{className:"TournamentCard-detailsLink",href:r,target:"_blank",rel:"noopener noreferrer"},"详情"),m("div",{className:"TournamentCard-content"},m("div",{className:"TournamentCard-title"},a),m("div",{className:"TournamentCard-prizePool"},m("label",null,"奖池"),m("span",null,e)),m("div",{className:"Timer"},m("label",null,"开始于"),m("div",{className:"Timer-display"},o.days,"天 ",o.hours,":",o.mins,":",o.secs)),!u&&s.session.user&&m(l,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>{s.modal.show(g,{onParticipate:T})}},"立即参加"),u&&m("div",{className:"TournamentCard-participated"},m("i",{className:"fas fa-check-circle"})," 已参加"),!s.session.user&&m(l,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>s.route("login")},"登录参加")))}}class N extends c{constructor(){super(...arguments),this.showAll=!1}view(t){const{participants:a}=t.attrs,e=this.showAll?a:a.slice(0,5);return m("div",{className:"Leaderboard"},m("div",{className:"Leaderboard-header"},m("h3",null,"排行榜"),m("h4",null,"积分")),m("ul",{className:"Leaderboard-list"},e.length>0?e.map((r,n)=>m("li",{className:`Leaderboard-item rank-${n+1}`,key:r.id},m("span",{className:"Leaderboard-rank"},m("i",{className:this.getRankIcon(n+1)})," ",n+1),m("span",{className:"Leaderboard-user"},m("div",{className:"username"},r.user.displayName),m("div",{className:"prize"},m("i",{className:"fas fa-gem"})," ",r.score)),m("span",{className:"Leaderboard-score"},r.score))):m("div",{className:"Leaderboard-empty"},"暂无参与者")),!this.showAll&&a.length>5&&m(l,{className:"Button Button--block Leaderboard-expandBtn",onclick:()=>{this.showAll=!0}},"详情 (查看全部 ",a.length," 名)"),this.showAll&&a.length>5&&m(l,{className:"Button Button--block Leaderboard-collapseBtn",onclick:()=>{this.showAll=!1}},"收起"))}getRankIcon(t){return t===1?"fas fa-crown rank-gold":t===2?"fas fa-crown rank-silver":t===3?"fas fa-crown rank-bronze":"fas fa-medal"}}function v(i){const t=Math.floor(i/1e3),a=Math.floor(t/60),e=Math.floor(a/60),r=Math.floor(e/24);return{days:String(r).padStart(2,"0"),hours:String(e%24).padStart(2,"0"),mins:String(a%60).padStart(2,"0"),secs:String(t%60).padStart(2,"0")}}class w extends c{constructor(){super(...arguments),this.loading=!0,this.tournamentData=null,this.timerInterval=null,this.timeElapsed={days:"00",hours:"00",mins:"00",secs:"00"}}oninit(t){super.oninit(t),this.loadData()}oncreate(t){super.oncreate(t),this.startTimer()}onremove(t){super.onremove(t),this.timerInterval&&clearInterval(this.timerInterval)}view(){return this.loading?m("div",{className:"TournamentWidget"},m("div",{className:"TournamentWidget-loading"},m(p,null))):this.tournamentData?m("div",{className:"TournamentWidget"},m(b,{title:this.tournamentData.title,prizePool:this.tournamentData.prizePool,detailsUrl:this.tournamentData.detailsUrl,backgroundImage:this.tournamentData.backgroundImage,timeElapsed:this.timeElapsed,userParticipated:this.tournamentData.userParticipated,onParticipate:()=>this.loadData()}),m(N,{participants:this.tournamentData.participants})):null}startTimer(){var a;if(!((a=this.tournamentData)!=null&&a.startDate))return;const t=new Date(this.tournamentData.startDate);this.timerInterval=setInterval(()=>{const e=new Date().getTime()-t.getTime();e>0&&(this.timeElapsed=v(e),m.redraw())},1e3)}loadData(){return this.loading=!0,s.request({method:"GET",url:s.forum.attribute("apiUrl")+"/tournament"}).then(t=>{this.tournamentData={title:t.data.attributes.title,prizePool:t.data.attributes.prizePool,startDate:t.data.attributes.startDate,detailsUrl:t.data.attributes.detailsUrl,backgroundImage:t.data.attributes.backgroundImage,userParticipated:t.data.attributes.userParticipated,totalParticipants:t.data.attributes.totalParticipants,participants:t.data.attributes.participants||[]},this.loading=!1,this.timerInterval||this.startTimer(),m.redraw()}).catch(t=>{this.loading=!1,console.error("Failed to load tournament data:",t),m.redraw()})}}s.initializers.add("wusong8899-tournament-widget",()=>{d?h.extend(d.prototype,"content",function(i){const t=i.children;if(!Array.isArray(t))return;const a=t.findIndex(e=>{var r,n;return(n=(r=e==null?void 0:e.attrs)==null?void 0:r.className)==null?void 0:n.includes("user-submission-widget-dynamic")});a>-1&&t.splice(a+1,0,m(w))}):console.warn("TagsPage not found - tournament widget will not be injected")})})(flarum.core.compat["forum/app"],flarum.core.compat["common/extend"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/LoadingIndicator"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Modal"],flarum.core.compat["tags/forum/components/TagsPage"]);
//# sourceMappingURL=forum.js.map

module.exports={};