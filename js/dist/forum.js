(function(r,b,e,u,v,c,T,f,w,P,g,N){"use strict";class p{view({attrs:a}){const{platform:t,size:s="medium"}=a;if(!t)return f("fas fa-gamepad",{className:`PlatformIcon PlatformIcon--${s}`});const o=`PlatformIcon PlatformIcon--${s}`;return t.iconUrl?m("img",{src:t.iconUrl,alt:t.name,className:o}):t.iconClass?f(t.iconClass,{className:o}):f("fas fa-gamepad",{className:o})}}class k extends u{oninit(a){super.oninit(a),this.state={showDropdown:!1}}view(){const{selectedPlatform:a}=this.attrs,{showDropdown:t}=this.state;return m("div",{className:"TournamentPlatformSelector"},m("div",{className:"TournamentPlatformSelector-label"},"游戏平台"),m("div",{className:"TournamentPlatformSelector-dropdown",onclick:()=>this.toggleDropdown()},m("div",{className:"TournamentPlatformSelector-selected"},m("div",{className:"TournamentPlatformSelector-info"},m("div",{className:"TournamentPlatformSelector-icon"},m(p,{platform:a,size:"medium"})),m("div",{className:"TournamentPlatformSelector-details"},m("div",{className:"TournamentPlatformSelector-name"},this.getPlatformName(a))))),f("fas fa-chevron-down",{className:"TournamentPlatformSelector-dropdownIcon"})),t&&this.renderPlatformDropdown())}toggleDropdown(){this.state.showDropdown=!this.state.showDropdown}getPlatformName(a){return a&&a.name||"请选择游戏平台"}renderPlatformDropdown(){const{platforms:a}=this.attrs;return!a||a.length===0?m("div",{className:"TournamentPlatformSelector-dropdownMenu"},m("div",{className:"TournamentPlatformSelector-dropdownItem TournamentPlatformSelector-noData"},"暂无可选平台")):m("div",{className:"TournamentPlatformSelector-dropdownMenu"},a.map(t=>m("div",{key:t.id,className:"TournamentPlatformSelector-dropdownItem",onclick:()=>this.selectPlatform(t)},m("div",{className:"TournamentPlatformSelector-icon"},m(p,{platform:t,size:"small"})),m("div",{className:"TournamentPlatformSelector-name"},t.name))))}selectPlatform(a){const{onPlatformSelect:t}=this.attrs;t(a),this.state.showDropdown=!1}}class y extends T{constructor(){super(...arguments),this.platformAccount="",this.platformUsername="",this.selectedPlatform=null,this.platforms=[],this.loading=!1,this.loadingPlatforms=!0,this.errors={}}oninit(a){super.oninit(a),this.loadPlatforms()}className(){return"ParticipateModal Modal--small"}title(){return r.translator.trans("wusong8899-tournament-widget.forum.participate_modal.title")}content(){return this.loadingPlatforms?e("div",{className:"Modal-body"},e("div",{className:"LoadingIndicator"}),e("p",null,"加载平台信息中...")):e("div",{className:"Modal-body"},e("div",{className:"Form"},e("div",{className:"Form-group"},e(k,{platforms:this.platforms,selectedPlatform:this.selectedPlatform,onPlatformSelect:a=>this.onPlatformSelect(a)}),this.errors.platform&&e("div",{className:"Alert Alert--error",style:{marginTop:"8px"}},this.errors.platform),this.errors.platformId&&e("div",{className:"Alert Alert--error",style:{marginTop:"8px"}},this.errors.platformId)),e("div",{className:"Form-group"},e("label",{className:"FormLabel"},"平台用户名"),e("input",{className:this.errors.platformUsername?"FormControl FormControl--error":"FormControl",type:"text",placeholder:"请输入您在该平台的用户名（支持中文、英文、数字等任意字符）",value:this.platformUsername,oninput:a=>{this.platformUsername=a.target.value,this.errors.platformUsername&&(delete this.errors.platformUsername,e.redraw())}}),this.errors.platformUsername&&e("div",{className:"Alert Alert--error",style:{marginTop:"8px"}},this.errors.platformUsername)),e("div",{className:"Form-group"},e(c,{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.selectedPlatform||!this.platformUsername.trim(),onclick:this.onsubmit.bind(this)},r.translator.trans("wusong8899-tournament-widget.forum.participate_modal.submit")))))}onsubmit(a){if(a.preventDefault(),this.errors={},this.selectedPlatform||(this.errors.platform=r.translator.trans("wusong8899-tournament-widget.forum.participate_modal.platform_required")),this.platformUsername.trim()||(this.errors.platformUsername=r.translator.trans("wusong8899-tournament-widget.forum.participate_modal.username_required")),Object.keys(this.errors).length>0){e.redraw();return}this.loading=!0,r.request({method:"POST",url:r.forum.attribute("apiUrl")+"/tournament/participate",body:{data:{attributes:{platformId:this.selectedPlatform.id,platformUsername:this.platformUsername.trim(),platformAccount:this.platformUsername.trim()}}}}).then(()=>{this.loading=!1,r.modal.close(),r.alerts.show({type:"success"},r.translator.trans("wusong8899-tournament-widget.forum.participate_modal.success")),this.attrs.onParticipate?.()},t=>{this.loading=!1,this.handleError(t),e.redraw()})}loadPlatforms(){r.request({method:"GET",url:r.forum.attribute("apiUrl")+"/tournament/platforms"}).then(a=>{this.platforms=a.data.map(t=>({id:t.id,name:t.attributes.name,iconUrl:t.attributes.iconUrl,iconClass:t.attributes.iconClass,isActive:t.attributes.isActive,displayOrder:t.attributes.displayOrder})),this.loadingPlatforms=!1,e.redraw()},a=>{console.error("Failed to load platforms:",a),this.loadingPlatforms=!1,r.alerts.show({type:"error"},"加载平台信息失败"),e.redraw()})}onPlatformSelect(a){this.selectedPlatform=a,this.platformUsername="",delete this.errors.platform,delete this.errors.platformId}handleError(a){if(this.errors={},a?.response?.errors)a.response.errors.forEach(s=>{if(s.source?.pointer){const o=s.source.pointer.replace("/data/attributes/","");this.errors[o]=s.detail||s.title}else r.alerts.show({type:"error"},s.detail||s.title||r.translator.trans("wusong8899-tournament-widget.forum.participate_modal.error"))});else if(a?.response?.data?.errors){const t=a.response.data.errors;Object.keys(t).forEach(s=>{this.errors[s]=t[s][0]})}else{const t=a?.response?.data?.message||a?.message||r.translator.trans("wusong8899-tournament-widget.forum.participate_modal.error");r.alerts.show({type:"error"},t)}}}class D extends u{view(a){const{title:t,prizePool:s,detailsUrl:o,backgroundImage:l,timeElapsed:n,userParticipated:h,userApplicationStatus:d,onParticipate:L}=a.attrs;return m("div",{className:"TournamentCard",style:{background:`url(${l}) center/cover no-repeat, linear-gradient(75.2deg, #2129a7 0.57%, #132cd1 72.59%)`}},m("div",{className:"TournamentCard-header"},m("div",{className:"TournamentCard-title"},t),m("a",{className:"TournamentCard-detailsLink",href:o,target:"_blank",rel:"noopener noreferrer"},r.translator.trans("wusong8899-tournament-widget.forum.tournament.details")),m("div",{className:"TournamentCard-prizePool"},m("label",null,r.translator.trans("wusong8899-tournament-widget.forum.tournament.prize_pool")),m("span",null,s))),m("div",{className:"TournamentCard-content"},m("div",{className:"TournamentCard-contentRow"},m("div",{className:"Timer"},m("label",null,r.translator.trans("wusong8899-tournament-widget.forum.tournament.started_at")),m("div",{className:"Timer-display"},m("div",{className:"Timer-boxes"},m("div",{className:"Timer-unit"},m("strong",null,n.days)),m("span",{className:"Timer-separator"},":"),m("div",{className:"Timer-unit"},m("strong",null,n.hours)),m("span",{className:"Timer-separator"},":"),m("div",{className:"Timer-unit"},m("strong",null,n.mins)),m("span",{className:"Timer-separator"},":"),m("div",{className:"Timer-unit"},m("strong",null,n.secs))),m("div",{className:"Timer-labels"},m("div",{className:"Timer-label"},"DAYS"),m("span",{className:"Timer-spacer"}),m("div",{className:"Timer-label"},"HRS"),m("span",{className:"Timer-spacer"}),m("div",{className:"Timer-label"},"MINS"),m("span",{className:"Timer-spacer"}),m("div",{className:"Timer-label"},"SECS")))),m("div",{className:"TournamentCard-actions"},!h&&r.session.user&&m(c,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>{r.modal.show(y,{onParticipate:L})}},r.translator.trans("wusong8899-tournament-widget.forum.tournament.participate_now")),h&&d&&m("div",{className:`TournamentCard-status ${d.isApproved?"approved":"pending"}`},d.isApproved?m("[",null,m("i",{className:"fas fa-check-circle"}),r.translator.trans("wusong8899-tournament-widget.forum.tournament.approved")):m("[",null,m("i",{className:"fas fa-clock"}),r.translator.trans("wusong8899-tournament-widget.forum.tournament.pending_approval"))),!r.session.user&&m(c,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>r.route("login")},r.translator.trans("wusong8899-tournament-widget.forum.tournament.login_to_participate"))))))}}class I extends u{constructor(){super(...arguments),this.containerRef=null}oncreate(a){super.oncreate(a),this.containerRef=a.dom,this.observeResize()}onremove(){this.resizeObserver&&this.resizeObserver.disconnect()}observeResize(){!this.containerRef||typeof ResizeObserver>"u"||(this.resizeObserver=new ResizeObserver(a=>{for(let t of a){const s=t.contentRect.width;s<640?(this.containerRef?.classList.add("compact-view"),this.containerRef?.classList.remove("wide-view")):s>1200?(this.containerRef?.classList.add("wide-view"),this.containerRef?.classList.remove("compact-view")):this.containerRef?.classList.remove("compact-view","wide-view")}}),this.resizeObserver.observe(this.containerRef))}view(a){const{participants:t}=a.attrs,s=r.forum.attribute("wusong8899_tournament.preview_limit"),o=s?parseInt(s):5,l=t.slice(0,o);return e("div",{className:"Leaderboard"},e("div",{className:"Leaderboard-header"},e("div",{className:"Leaderboard-headerRow"},e("div",{className:"Leaderboard-headerCell rank"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.rank")),e("div",{className:"Leaderboard-headerCell user"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.user")),e("div",{className:"Leaderboard-headerCell platform"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.platform")),e("div",{className:"Leaderboard-headerCell score"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.amount")))),e("div",{className:"Leaderboard-list"},l.length>0?l.map(n=>e("div",{className:`Leaderboard-item rank-${n.rank}`,key:n.id,"data-rank":`#${n.rank}`,title:`${n.user.displayName} - ${n.title}`},e("div",{className:"Leaderboard-cell rank"},e("i",{className:this.getRankIcon(n.rank)}),e("span",{className:"rank-number"},n.rank)),e("div",{className:"Leaderboard-cell user"},e("div",{className:"user-info"},this.renderUserAvatar(n.user),e("div",{className:"user-details"},e("span",{className:"user-name"},n.user.displayName),e("span",{className:"user-title"},n.title)))),e("div",{className:"Leaderboard-cell platform"},e("div",{className:"platform-info"},this.renderPlatformIcon(n.platform),e("div",{className:"platform-details"},e("div",{className:"platform-name"},n.platform.name)))),e("div",{className:"Leaderboard-cell score"},e("span",{className:`score-amount ${n.amount<0?"negative":n.amount>0?"positive":"zero"}`},n.amount)))):e("div",{className:"Leaderboard-empty"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.no_participants"))),t.length>o&&e(c,{className:"Button Button--block Leaderboard-detailsBtn",onclick:n=>{n.preventDefault(),n.stopPropagation();try{window.location.href=r.route("tournament.rankings")}catch(h){console.error("Navigation error:",h);try{e.route.set("/tournament/rankings")}catch(d){console.error("Fallback navigation failed:",d),window.location.href="/tournament/rankings"}}}},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.view_details")))}getRankIcon(a){return a===1?"fas fa-crown rank-gold":a===2?"fas fa-crown rank-silver":a===3?"fas fa-crown rank-bronze":"fas fa-medal"}renderUserAvatar(a){const t=r.store.getById("users",a.id);return t?w(t,{className:"user-avatar"}):a.avatarUrl?e("img",{className:"user-avatar",src:a.avatarUrl,alt:a.displayName}):e("div",{className:"user-avatar user-avatar--default"},e("i",{className:"fas fa-user"}))}renderPlatformIcon(a){return a.usesUrlIcon&&a.iconUrl?e("img",{className:"platform-icon image-icon",src:a.iconUrl,alt:a.name}):a.usesCssIcon&&a.iconClass?e("i",{className:`platform-icon css-icon ${a.iconClass}`}):e("i",{className:"platform-icon css-icon fas fa-gamepad"})}}function S(i){const a=Math.floor(i/1e3),t=Math.floor(a/60),s=Math.floor(t/60),o=Math.floor(s/24);return{days:String(o).padStart(2,"0"),hours:String(s%24).padStart(2,"0"),mins:String(t%60).padStart(2,"0"),secs:String(a%60).padStart(2,"0")}}class U extends u{constructor(){super(...arguments),this.loading=!0,this.tournamentData=null,this.timerInterval=null,this.animationFrame=null,this.timeElapsed={days:"00",hours:"00",mins:"00",secs:"00"},this.lastUpdateTime=0,this.isRedrawing=!1}oninit(a){super.oninit(a),this.loadData()}oncreate(a){super.oncreate(a),this.startTimer()}onremove(a){super.onremove(a),this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),this.tournamentData=null,this.isRedrawing=!1}view(){try{return this.loading?e("div",{className:"TournamentWidget"},e("div",{className:"TournamentWidget-loading"},e(v,null))):this.tournamentData?e("div",{className:"TournamentWidget"},e("div",{className:"TournamentHeader"},e("img",{className:"TournamentHeader-image",src:this.tournamentData.headerImage||"https://i.mji.rip/2025/08/23/678aa40f68db12909bb4a4871d603876.webp",alt:"Tournament"}),e("span",{className:"TournamentHeader-title"},this.tournamentData.headerTitle||"老哥榜")),e(D,{title:this.tournamentData.title,prizePool:this.tournamentData.prizePool,detailsUrl:this.tournamentData.detailsUrl,backgroundImage:this.tournamentData.backgroundImage,timeElapsed:this.timeElapsed,userParticipated:this.tournamentData.userParticipated,userApplicationStatus:this.tournamentData.userApplicationStatus,onParticipate:()=>this.loadData()}),e(I,{participants:this.tournamentData.participants})):null}catch(a){return console.error("TournamentWidget view error:",a),e("div",{className:"TournamentWidget TournamentWidget--error"},e("div",{className:"TournamentWidget-error"},e("p",null,"Tournament widget encountered an error. Please refresh the page.")))}}startTimer(){if(!this.tournamentData?.startDate)return;const a=new Date(this.tournamentData.startDate);this.lastUpdateTime=Date.now();const t=()=>{if(this.isRedrawing||!this.tournamentData)return;const s=Date.now();if(s-this.lastUpdateTime>=1e3){const o=s-a.getTime();if(o>0){this.timeElapsed=S(o),this.lastUpdateTime=s,this.isRedrawing=!0;try{e.redraw()}catch(l){console.error("Tournament timer redraw error:",l)}finally{setTimeout(()=>{this.isRedrawing=!1},10)}}}this.tournamentData&&!this.isRedrawing&&(this.animationFrame=requestAnimationFrame(t))};this.animationFrame=requestAnimationFrame(t)}loadData(){return this.loading?Promise.resolve():(this.loading=!0,r.request({method:"GET",url:r.forum.attribute("apiUrl")+"/tournament"}).then(a=>{if(!a||!a.data||!a.data.attributes)throw new Error("Invalid tournament data response");this.tournamentData={title:a.data.attributes.title||"Tournament",prizePool:a.data.attributes.prizePool||"0",startDate:a.data.attributes.startDate||new Date().toISOString(),detailsUrl:a.data.attributes.detailsUrl||"",backgroundImage:a.data.attributes.backgroundImage||"",headerTitle:a.data.attributes.headerTitle||"",headerImage:a.data.attributes.headerImage||"",userParticipated:a.data.attributes.userParticipated||!1,userApplicationStatus:a.data.attributes.userApplicationStatus||null,totalParticipants:a.data.attributes.totalParticipants||0,participants:a.data.attributes.participants||[]},this.loading=!1,!this.timerInterval&&this.tournamentData.startDate&&this.startTimer();try{e.redraw()}catch(t){console.error("Failed to redraw after loading data:",t)}}).catch(a=>{this.loading=!1,console.error("Failed to load tournament data:",a),this.tournamentData={title:"Tournament",prizePool:"0",startDate:new Date().toISOString(),detailsUrl:"",backgroundImage:"",headerTitle:"Tournament",headerImage:"",userParticipated:!1,userApplicationStatus:null,totalParticipants:0,participants:[]};try{e.redraw()}catch(t){console.error("Failed to redraw after error:",t)}}))}}class R extends P{constructor(){super(...arguments),this.loading=!0,this.tournamentData=null,this.error=null}oninit(a){super.oninit(a),r.setTitle(r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.full_rankings_title")),this.loadTournamentData()}async loadTournamentData(){try{this.loading=!0,m.redraw();const a=await r.request({method:"GET",url:`${r.forum.attribute("apiUrl")}/tournament`});if(a&&a.data&&a.data.attributes)this.tournamentData=a.data.attributes,this.error=null;else throw new Error("Invalid response format")}catch(a){console.error("Failed to load tournament data:",a),this.error="Failed to load tournament data"}finally{this.loading=!1,m.redraw()}}view(){try{return m("div",{className:"TournamentRankingsPage"},this.content())}catch(a){return console.error("TournamentRankingsPage view error:",a),m("div",{className:"TournamentRankingsPage TournamentRankingsPage--error"},m("div",{className:"container"},m("div",{className:"TournamentRankingsPage-error"},m("h2",null,"Error loading tournament rankings"),m("p",null,"Please refresh the page or go back to homepage."),m(g,{href:"/",className:"Button Button--primary"},"返回首页"))))}}content(){if(this.loading)return m(v,null);if(this.error||!this.tournamentData)return m("div",{className:"container"},m("div",{className:"TournamentRankingsPage-error"},m("h2",null,r.translator.trans("core.forum.error.generic_message")),m("p",null,this.error||"Tournament data not available"),m(g,{href:"/",className:"Button Button--primary"},r.translator.trans("core.forum.error.return_link"))));const{tournamentData:a}=this;return m("div",{className:"container"},m("div",{className:"TournamentRankingsPage-header"},m("div",{className:"TournamentRankingsPage-navigation"},m(g,{href:"/",className:"Button Button--text"},m("i",{className:"fas fa-arrow-left"}),"返回")),m("h1",{className:"TournamentRankingsPage-title"},a.headerTitle||r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.full_rankings_title")),m("div",{className:"TournamentRankingsPage-tournamentInfo"},m("h2",null,a.title),m("p",{className:"TournamentRankingsPage-prizePool"},r.translator.trans("wusong8899-tournament-widget.forum.tournament.prize_pool"),": ",a.prizePool))),m("div",{className:"TournamentRankingsPage-leaderboard"},this.renderFullLeaderboard()))}renderFullLeaderboard(){return!this.tournamentData||!this.tournamentData.participants.length?m("div",{className:"TournamentRankingsPage-empty"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.no_participants")):m("div",{className:"Leaderboard Leaderboard--fullPage"},m("div",{className:"Leaderboard-header"},m("div",{className:"Leaderboard-headerRow"},m("div",{className:"Leaderboard-headerCell rank"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.rank")),m("div",{className:"Leaderboard-headerCell user"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.user")),m("div",{className:"Leaderboard-headerCell platform"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.platform")),m("div",{className:"Leaderboard-headerCell score"},r.translator.trans("wusong8899-tournament-widget.forum.leaderboard.amount")))),m("div",{className:"Leaderboard-list"},this.tournamentData.participants.map(a=>m("div",{className:`Leaderboard-item rank-${a.rank}`,key:a.id,"data-rank":`#${a.rank}`,title:`${a.user.displayName} - ${a.title}`},m("div",{className:"Leaderboard-cell rank"},m("i",{className:this.getRankIcon(a.rank)}),m("span",{className:"rank-number"},a.rank)),m("div",{className:"Leaderboard-cell user"},m("div",{className:"user-info"},this.renderUserAvatar(a.user),m("div",{className:"user-details"},m("span",{className:"user-name"},a.user.displayName),m("span",{className:"user-title"},a.title)))),m("div",{className:"Leaderboard-cell platform"},m("div",{className:"platform-info"},this.renderPlatformIcon(a.platform),m("div",{className:"platform-details"},m("div",{className:"platform-name"},a.platform.name)))),m("div",{className:"Leaderboard-cell score"},m("span",{className:`score-amount ${a.amount<0?"negative":a.amount>0?"positive":"zero"}`},a.amount))))))}getRankIcon(a){return a===1?"fas fa-crown rank-gold":a===2?"fas fa-crown rank-silver":a===3?"fas fa-crown rank-bronze":"fas fa-medal"}renderUserAvatar(a){const t=r.store.getById("users",a.id);return t?w(t,{className:"user-avatar"}):a.avatarUrl?m("img",{className:"user-avatar",src:a.avatarUrl,alt:a.displayName}):m("div",{className:"user-avatar user-avatar--default"},m("i",{className:"fas fa-user"}))}renderPlatformIcon(a){return a.usesUrlIcon&&a.iconUrl?m("img",{className:"platform-icon image-icon",src:a.iconUrl,alt:a.name}):a.usesCssIcon&&a.iconClass?m("i",{className:`platform-icon css-icon ${a.iconClass}`}):m("i",{className:"platform-icon css-icon fas fa-gamepad"})}}r.initializers.add("wusong8899-tournament-widget",()=>{r.routes["tournament.rankings"]={path:"/tournament/rankings",component:R},N?b.extend(N.prototype,"content",function(i){const a=i.children;Array.isArray(a)&&a.push(e(U))}):console.warn("TagsPage not found - tournament widget will not be injected")})})(flarum.core.compat["forum/app"],flarum.core.compat["common/extend"],m,flarum.core.compat["common/Component"],flarum.core.compat["common/components/LoadingIndicator"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/helpers/icon"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/components/Page"],flarum.core.compat["common/components/LinkButton"],flarum.core.compat["tags/forum/components/TagsPage"]);
//# sourceMappingURL=forum.js.map

module.exports={};