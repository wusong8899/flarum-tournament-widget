(function(e,w,s,c,N,d,v,u,f){"use strict";class h{view({attrs:t}){const{platform:a,size:o="medium"}=t;if(!a)return u("fas fa-gamepad",{className:`PlatformIcon PlatformIcon--${o}`});const r=`PlatformIcon PlatformIcon--${o}`;return a.iconUrl?m("img",{src:a.iconUrl,alt:a.name,className:r}):a.iconClass?u(a.iconClass,{className:r}):u("fas fa-gamepad",{className:r})}}class p extends c{oninit(t){super.oninit(t),this.state={showDropdown:!1}}view(){const{selectedPlatform:t}=this.attrs,{showDropdown:a}=this.state;return m("div",{className:"TournamentPlatformSelector"},m("div",{className:"TournamentPlatformSelector-label"},"游戏平台"),m("div",{className:"TournamentPlatformSelector-dropdown",onclick:()=>this.toggleDropdown()},m("div",{className:"TournamentPlatformSelector-selected"},m("div",{className:"TournamentPlatformSelector-info"},m("div",{className:"TournamentPlatformSelector-icon"},m(h,{platform:t,size:"medium"})),m("div",{className:"TournamentPlatformSelector-details"},m("div",{className:"TournamentPlatformSelector-name"},this.getPlatformName(t))))),u("fas fa-chevron-down",{className:"TournamentPlatformSelector-dropdownIcon"})),a&&this.renderPlatformDropdown())}toggleDropdown(){this.state.showDropdown=!this.state.showDropdown}getPlatformName(t){return t&&t.name||"请选择游戏平台"}renderPlatformDropdown(){const{platforms:t}=this.attrs;return!t||t.length===0?m("div",{className:"TournamentPlatformSelector-dropdownMenu"},m("div",{className:"TournamentPlatformSelector-dropdownItem TournamentPlatformSelector-noData"},"暂无可选平台")):m("div",{className:"TournamentPlatformSelector-dropdownMenu"},t.map(a=>m("div",{key:a.id,className:"TournamentPlatformSelector-dropdownItem",onclick:()=>this.selectPlatform(a)},m("div",{className:"TournamentPlatformSelector-icon"},m(h,{platform:a,size:"small"})),m("div",{className:"TournamentPlatformSelector-name"},a.name))))}selectPlatform(t){const{onPlatformSelect:a}=this.attrs;a(t),this.state.showDropdown=!1}}class b extends v{constructor(){super(...arguments),this.platformAccount="",this.platformUsername="",this.selectedPlatform=null,this.platforms=[],this.loading=!1,this.loadingPlatforms=!0}oninit(t){super.oninit(t),this.loadPlatforms()}className(){return"ParticipateModal Modal--small"}title(){return e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.title")}content(){return this.loadingPlatforms?s("div",{className:"Modal-body"},s("div",{className:"LoadingIndicator"}),s("p",null,"加载平台信息中...")):s("div",{className:"Modal-body"},s("div",{className:"Form"},s("div",{className:"Form-group"},s(p,{platforms:this.platforms,selectedPlatform:this.selectedPlatform,onPlatformSelect:t=>this.onPlatformSelect(t)})),s("div",{className:"Form-group"},s("label",{className:"FormLabel"},"平台用户名"),s("input",{className:"FormControl",type:"text",placeholder:"请输入您在该平台的用户名",value:this.platformUsername,oninput:t=>{this.platformUsername=t.target.value}})),s("div",{className:"Form-group"},s(d,{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.selectedPlatform||!this.platformUsername.trim(),onclick:this.onsubmit.bind(this)},e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.submit")))))}onsubmit(t){t.preventDefault(),!(!this.selectedPlatform||!this.platformUsername.trim())&&(this.loading=!0,e.request({method:"POST",url:e.forum.attribute("apiUrl")+"/tournament/participate",body:{data:{attributes:{platformId:this.selectedPlatform.id,platformUsername:this.platformUsername.trim(),platformAccount:this.platformUsername.trim()}}}}).then(()=>{var a,o;this.hide(),e.alerts.show("success",e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.success")),(o=(a=this.attrs).onParticipate)==null||o.call(a)},a=>{var r,l,i;this.loading=!1;const o=((i=(l=(r=a==null?void 0:a.response)==null?void 0:r.errors)==null?void 0:l[0])==null?void 0:i.detail)||e.translator.trans("wusong8899-tournament-widget.forum.participate_modal.error");e.alerts.show("error",o)}))}loadPlatforms(){e.request({method:"GET",url:e.forum.attribute("apiUrl")+"/tournament/platforms"}).then(t=>{this.platforms=t.data.map(a=>({id:a.id,name:a.attributes.name,iconUrl:a.attributes.iconUrl,iconClass:a.attributes.iconClass,isActive:a.attributes.isActive,displayOrder:a.attributes.displayOrder})),this.loadingPlatforms=!1,s.redraw()},t=>{console.error("Failed to load platforms:",t),this.loadingPlatforms=!1,e.alerts.show("error","加载平台信息失败"),s.redraw()})}onPlatformSelect(t){this.selectedPlatform=t,this.platformUsername=""}}class P extends c{view(t){const{title:a,prizePool:o,detailsUrl:r,backgroundImage:l,timeElapsed:i,userParticipated:g,onParticipate:S}=t.attrs;return m("div",{className:"TournamentCard",style:{backgroundImage:`url(${l})`}},m("a",{className:"TournamentCard-detailsLink",href:r,target:"_blank",rel:"noopener noreferrer"},e.translator.trans("wusong8899-tournament-widget.forum.tournament.details")),m("div",{className:"TournamentCard-content"},m("div",{className:"TournamentCard-title"},a),m("div",{className:"TournamentCard-prizePool"},m("label",null,e.translator.trans("wusong8899-tournament-widget.forum.tournament.prize_pool")),m("span",null,o)),m("div",{className:"Timer"},m("label",null,e.translator.trans("wusong8899-tournament-widget.forum.tournament.started_at")),m("div",{className:"Timer-display"},i.days,"天 ",i.hours,":",i.mins,":",i.secs)),!g&&e.session.user&&m(d,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>{e.modal.show(b,{onParticipate:S})}},e.translator.trans("wusong8899-tournament-widget.forum.tournament.participate_now")),g&&m("div",{className:"TournamentCard-participated"},m("i",{className:"fas fa-check-circle"})," ",e.translator.trans("wusong8899-tournament-widget.forum.tournament.participated")),!e.session.user&&m(d,{className:"Button Button--primary TournamentCard-participateBtn",onclick:()=>e.route("login")},e.translator.trans("wusong8899-tournament-widget.forum.tournament.login_to_participate"))))}}class T extends c{constructor(){super(...arguments),this.showAll=!1}view(t){const{participants:a}=t.attrs,o=this.showAll?a:a.slice(0,5);return m("div",{className:"Leaderboard"},m("div",{className:"Leaderboard-header"},m("div",{className:"Leaderboard-headerRow"},m("div",{className:"Leaderboard-headerCell rank"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.rank")),m("div",{className:"Leaderboard-headerCell title"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.rank_title")),m("div",{className:"Leaderboard-headerCell user"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.user")),m("div",{className:"Leaderboard-headerCell platform"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.platform")),m("div",{className:"Leaderboard-headerCell score"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.score")))),m("div",{className:"Leaderboard-list"},o.length>0?o.map(r=>m("div",{className:`Leaderboard-item rank-${r.rank}`,key:r.id},m("div",{className:"Leaderboard-cell rank"},m("i",{className:this.getRankIcon(r.rank)}),m("span",{className:"rank-number"},r.rank)),m("div",{className:"Leaderboard-cell title"},m("span",{className:"title-text"},r.title)),m("div",{className:"Leaderboard-cell user"},m("div",{className:"user-info"},r.user.avatarUrl&&m("img",{className:"user-avatar",src:r.user.avatarUrl,alt:r.user.displayName}),m("span",{className:"user-name"},r.user.displayName))),m("div",{className:"Leaderboard-cell platform"},m("div",{className:"platform-info"},this.renderPlatformIcon(r.platform),m("div",{className:"platform-details"},m("div",{className:"platform-name"},r.platform.name),m("div",{className:"platform-username"},r.platform.username)))),m("div",{className:"Leaderboard-cell score"},m("span",{className:"score-amount"},r.score)))):m("div",{className:"Leaderboard-empty"},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.no_participants"))),!this.showAll&&a.length>5&&m(d,{className:"Button Button--block Leaderboard-expandBtn",onclick:()=>{this.showAll=!0}},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.view_all",{count:a.length})),this.showAll&&a.length>5&&m(d,{className:"Button Button--block Leaderboard-collapseBtn",onclick:()=>{this.showAll=!1}},e.translator.trans("wusong8899-tournament-widget.forum.leaderboard.collapse")))}getRankIcon(t){return t===1?"fas fa-crown rank-gold":t===2?"fas fa-crown rank-silver":t===3?"fas fa-crown rank-bronze":"fas fa-medal"}renderPlatformIcon(t){return t.usesUrlIcon&&t.iconUrl?m("img",{className:"platform-icon image-icon",src:t.iconUrl,alt:t.name}):t.usesCssIcon&&t.iconClass?m("i",{className:`platform-icon css-icon ${t.iconClass}`}):m("i",{className:"platform-icon css-icon fas fa-gamepad"})}}function D(n){const t=Math.floor(n/1e3),a=Math.floor(t/60),o=Math.floor(a/60),r=Math.floor(o/24);return{days:String(r).padStart(2,"0"),hours:String(o%24).padStart(2,"0"),mins:String(a%60).padStart(2,"0"),secs:String(t%60).padStart(2,"0")}}class k extends c{constructor(){super(...arguments),this.loading=!0,this.tournamentData=null,this.timerInterval=null,this.animationFrame=null,this.timeElapsed={days:"00",hours:"00",mins:"00",secs:"00"},this.lastUpdateTime=0}oninit(t){super.oninit(t),this.loadData()}oncreate(t){super.oncreate(t),this.startTimer()}onremove(t){super.onremove(t),this.timerInterval&&clearInterval(this.timerInterval),this.animationFrame&&cancelAnimationFrame(this.animationFrame)}view(){return this.loading?s("div",{className:"TournamentWidget"},s("div",{className:"TournamentWidget-loading"},s(N,null))):this.tournamentData?s("div",{className:"TournamentWidget"},s("div",{className:"TournamentHeader"},s("img",{className:"TournamentHeader-image",src:"https://i.mji.rip/2025/08/23/678aa40f68db12909bb4a4871d603876.webp",alt:"Tournament"}),s("span",{className:"TournamentHeader-title"},"老哥榜")),s(P,{title:this.tournamentData.title,prizePool:this.tournamentData.prizePool,detailsUrl:this.tournamentData.detailsUrl,backgroundImage:this.tournamentData.backgroundImage,timeElapsed:this.timeElapsed,userParticipated:this.tournamentData.userParticipated,onParticipate:()=>this.loadData()}),s(T,{participants:this.tournamentData.participants})):null}startTimer(){var o;if(!((o=this.tournamentData)!=null&&o.startDate))return;const t=new Date(this.tournamentData.startDate);this.lastUpdateTime=Date.now();const a=()=>{const r=Date.now();if(r-this.lastUpdateTime>=1e3){const l=r-t.getTime();l>0&&(this.timeElapsed=D(l),this.lastUpdateTime=r,s.redraw())}this.animationFrame=requestAnimationFrame(a)};this.animationFrame=requestAnimationFrame(a)}loadData(){return this.loading=!0,e.request({method:"GET",url:e.forum.attribute("apiUrl")+"/tournament"}).then(t=>{this.tournamentData={title:t.data.attributes.title,prizePool:t.data.attributes.prizePool,startDate:t.data.attributes.startDate,detailsUrl:t.data.attributes.detailsUrl,backgroundImage:t.data.attributes.backgroundImage,userParticipated:t.data.attributes.userParticipated,totalParticipants:t.data.attributes.totalParticipants,participants:t.data.attributes.participants||[]},this.loading=!1,this.timerInterval||this.startTimer(),s.redraw()}).catch(t=>{this.loading=!1,console.error("Failed to load tournament data:",t),s.redraw()})}}e.initializers.add("wusong8899-tournament-widget",()=>{f?w.extend(f.prototype,"content",function(n){const t=n.children;Array.isArray(t)&&t.push(s(k))}):console.warn("TagsPage not found - tournament widget will not be injected")})})(flarum.core.compat["forum/app"],flarum.core.compat["common/extend"],m,flarum.core.compat["common/Component"],flarum.core.compat["common/components/LoadingIndicator"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/helpers/icon"],flarum.core.compat["tags/forum/components/TagsPage"]);
//# sourceMappingURL=forum.js.map

module.exports={};